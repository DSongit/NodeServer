<!DOCTYPE html>
<html lang="en">

<head>
    <title>Administration</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.0/bootstrap-table.min.js"></script>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.0/bootstrap-table.min.css">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <script src="javascript/moustache.min.js"></script>
    <script>


    
    var globals = {
        checkedRows: [],
        columns: [
        {
            title: 'Selected',
            checkbox: true            
        },
        {
            field: 'UserID',
            title: 'UserID',
        },
        {
            field: 'FirstName',
            title: 'First'
        },
        {
            field: 'LastName',
            title: 'Last'
        },
        {
            field: 'EmailAddress',
            title: 'E-Mail'
        },
        {
            field: 'Username',
            title: 'Username'
        },
        {
            field: 'Password',
            title: 'Password'
        }
    ]
    };


    function removeUser(){
        var obj = {
            ids: []
        };

        for(var i = 0; i < globals.checkedRows.length;i++){
         obj.ids.push(globals.checkedRows[i].UserID);
        }
        
        $.post('/admin/removeUser',obj);
        
        disable_delete(true);
       
        update_table();
    }
    

    function saveUser()
    {
        var obj = {
            firstname,
            lastname,
            email,
            username,
            password,
            id
        };

        obj.id = $('input[name=id]').val();
        obj.firstname = $('input[name=firstname]').val();
        obj.lastname = $('input[name=lastname]').val();
        obj.email = $('input[name=email]').val();
        obj.username = $('input[name=username]').val();
        obj.password = $('input[name=password]').val();

        
        console.log(obj); //TODO: Remove Debug Code
        
        $.post('/admin/updateUser',obj);     
        
        update_table(); 
    }

    function addUser()
    {
        var obj = {
            firstname,
            lastname,
            email,
            username,
            password
        };

        obj.firstname = $('input[name=firstname_add]').val();
        obj.lastname = $('input[name=lastname_add]').val();
        obj.email = $('input[name=email_add]').val();
        obj.username = $('input[name=username_add]').val();
        obj.password = $('input[name=password_add]').val();

        
        console.log(obj); //TODO: Remove Debug Code
        
        $.post('/admin/addUser',obj);     
        
        update_table();
    }

    function disable_delete(val)
    {
        if(val){
            $('#delete').prop('disabled',true);
        }else{
             $('#delete').removeAttr('disabled');
        }
    }



    function update_table(){

        $('#table').bootstrapTable('destroy');

        $.getJSON('/admin/getUsers',function(data){
            console.log(data); // DEBUG
            $('#table').bootstrapTable({
                "columns": globals.columns,
                "data": data,
                "pagination": true,
                "pageSize": 5,
                "search": true,
                onCheck: function(row,element){
                    console.log(row);
                    globals.checkedRows.push(row);
                    disable_delete(false);      
                },
                onCheckAll: function(rows){
                    globals.checkedRows = globals.checkedRows.concat(rows);
                    disable_delete(false);
                },
                onUncheck: function(row,element){
                    var index = globals.checkedRows.indexOf(row);
                    globals.checkedRows.splice(index,1);
                    if(globals.checkedRows.length < 1){
                        disable_delete(true);
                    }
                },
                onUncheckAll: function(rows,element){
                    globals.checkedRows = [];
                    disable_delete(true);
                    
                },
                onClickRow: function(row,element,field){
                    $('input[name=id]').val(row.UserID);
                    $('input[name=firstname]').val(row.FirstName);
                    $('input[name=lastname]').val(row.LastName);
                    $('input[name=email]').val(row.EmailAddress);
                    $('input[name=username]').val(row.Username);
                }
            });
        });
    }

   function init(){
            
            $('button[name=refresh]').click(update_table);
            $('button[name=add]').click(addUser);
            $('button[name=save]').click(saveUser);
            disable_delete(true);
            update_table();
            
        }

    $('document').ready(init);
 
 
 </script>
</head>

<body>
    <div class="container">
        <h1>Users</h1>
        <hr>
        <div class="bootstrap-table">
            <div class="fixed-table-toolbar">
                <div class="bs-bars pull-left">
                    <button id="delete" onclick="removeUser()" type="button" class="btn btn-large btn-block btn-danger"><i class="glyphicon glyphicon-remove"></i> Remove</button>
                </div>
                <div class="columns columns-right btn-group pull-right">
                    <button class="btn btn-default" type="button" name="refresh" title="Refresh"><i class="glyphicon glyphicon-refresh icon-refresh"></i></button>
                </div>
            </div>
            <div class="fixed-table-container">
                <table id="table"></table>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-6">
                <div class="container-fluid">
                    <div id="form-user-edit">
                        <form class="form-horizontal">
                            <fieldset>
                                <legend>Edit</legend>
                                <label class="control-label col-xs-2" for="id">ID</label>
                                <div class="col-xs-4">
                                    <input type="text" class="form-control" id="id" name="id" readonly>
                                </div>
                                <label class="control-label col-xs-2" for="firstname">Firstname</label>
                                <div class="col-xs-4">
                                    <input type="text" class="form-control" name="firstname">
                                </div>
                                <label class="control-label col-xs-2" for="lastname">Lastname</label>
                                <div class="col-xs-4">
                                    <input type="text" class="form-control" name="lastname">
                                </div>
                                <label class="control-label col-xs-2" for="email">Email</label>
                                <div class="col-xs-4">
                                    <input type="text" class="form-control" name="email">
                                </div>
                                <label class="control-label col-xs-2" for="username">Username</label>
                                <div class="col-xs-4">
                                    <input type="text" class="form-control" name="username">
                                </div>
                                <label class="control-label col-xs-2" for="password">Password</label>
                                <div class="col-xs-4">
                                    <input type="text" class="form-control" name="password">
                                </div>
                            </fieldset>
                        </form>
                        <button type="button" class="btn btn-warning" name="save">Save</button>
                    </div>
                </div>
            </div>
            <div class="col-xs-6">
                <div class="container-fluid">
                    <div id="form-user-add">
                        <form class="form-horizontal">
                            <fieldset>
                                <legend>Add</legend>
                                <label class="control-label col-xs-2" for="id">ID</label>
                                <div class="col-xs-4">
                                    <input type="text" class="form-control" id="id" name="id_add" readonly>
                                </div>
                                <label class="control-label col-xs-2" for="firstname">Firstname</label>
                                <div class="col-xs-4">
                                    <input type="text" class="form-control" id="firstname" name="firstname_add">
                                </div>
                                <label class="control-label col-xs-2" for="lastname">Lastname</label>
                                <div class="col-xs-4">
                                    <input type="text" class="form-control" id="lastname" name="lastname_add">
                                </div>
                                <label class="control-label col-xs-2" for="email">Email</label>
                                <div class="col-xs-4">
                                    <input type="text" class="form-control" id="email" name="email_add">
                                </div>
                                <label class="control-label col-xs-2" for="username">Username</label>
                                <div class="col-xs-4">
                                    <input type="text" class="form-control" id="username" name="username_add">
                                </div>
                                <label class="control-label col-xs-2" for="password">Password</label>
                                <div class="col-xs-4">
                                    <input type="text" class="form-control" id="password" name="password_add">
                                </div>
                            </fieldset>
                        </form>
                        <button type="button" class="btn btn-warning" name="add">Add</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>